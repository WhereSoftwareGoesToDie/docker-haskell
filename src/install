#!/bin/sh
set +x
set +e

cp /src/.cabal/config /root/.cabal/config

cd /src

apt-get update
cat apt-packages | xargs apt-get install

cabal update
# Stackage still has an old version of mtl.
# The packages responsible seem okay to ignore for us though.
# https://github.com/fpco/stackage/issues/217
cabal install --global 'mtl>=2.2'

STACKAGE="remote-repo: stackage-ghc78-inc:${STACKAGE_URL}"

sed -i -Ee "s#^remote-repo: (.*)\$#${STACKAGE}#" /root/.cabal/config
cabal update

# This is to prevent transformers 0.3
cabal install --global 'transformers-compat' -f -three

# alex, happy and other tools
cat cabal-tools | tr "\n" "\0" | xargs -0 cabal install --global

# preinstalled packages
cat cabal-packages | tr "\n" "\0" | xargs -0 cabal install --global
